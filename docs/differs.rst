.. role:: additions
    :class: additions
.. role:: deletions
    :class: deletions

.. _differs:

==================
Differs
==================
A differ is applied to the filtered data if it has changed from the previous run(s). A differ summarizes the changes in
the data and produces the content of the report sent to you. The output of the differ can be further filtered using any
of the filters listed in :ref:`filters` (see :ref:`diff_filters` below).

.. To convert the "webchanges --features" output, use:
   webchanges --features | sed -e 's/^  \* \(.*\) - \(.*\)$/- **\1**: \2/'

At the moment, the following differs are available:

  - :ref:`unified <unified_diff>`: (default) Compares data line-by-line, showing changed lines in a "unified format";
  - :ref:`command <command_diff>`: Executes an outside command that acts as a differ (e.g. wdiff);
  - :ref:`deepdiff <deepdiff_diff>`: Compares structured data (JSON or XML) element-by-element.
  - :ref:`table <table_diff>`: A Python version of the ``unified`` differ where the changes are displayed as an HTML
    table;

In addition, the following BETA differs are available:

  - :ref:`ai_google <ai_google_diff>`: Detects and summarizes changes using Generative AI.
  - :ref:`image <image_diff>`: Detects changes in an image and displays them as overlay over a grayscale version of the
    old image.


A differ is specified using the job directive ``differ``, which is typically a dictionary. However, to use the differ
with its default directive values, just specify the name of the differ:

.. code-block:: yaml

   url: https://example.net/unified.html
   differ: unified  # this entire line can be omitted as it's the default differ

.. code-block:: yaml

   url: https://example.net/deepdiff.html
   differ: deepdiff  # use deepdiff with the default directive values


Otherwise, specify the differ using the ``name`` key:

.. code-block:: yaml

   url: https://example.net/unified_no_range.html
   differ:
     name: unified
     rangeinfo: false


.. _unified_diff:

unified
-------
The default differ used when none is specified (except, for backward compatibility, when in the configration file the
``html`` report has the deprecated ``diff`` key set to ``table``).

It does a line-by-line comparison and reports lines that have been added (:additions:`+`), deleted (:deletions:`-`),
or changed. Changed lines are displayed twice: once marked as "deleted" (with a :deletions:`-` symbol) representing
the old content, and once as "added" (with a :additions:`+` symbol) representing the new content. The results are
displayed in the `unified format <https://en.wikipedia.org/wiki/Diff#Unified_format>`__ ("unified *diff*").

For HTML reports, :program:`webchanges` colorizes the unified diff for easier legibility.

Examples:

.. code-block:: yaml

   url: https://example.net/unified.html
   differ: unified  # this can also be omitted as it's the default


.. code-block:: yaml

   url: https://example.net/unified_no_range.html
   differ:
     name: unified
     rangeinfo: false


Optional directives
```````````````````
* ``rangeinfo`` Whether to include line range information lines (default: true)

.. versionchanged:: 3.21
   Became a standalone differ.
   Added the ``rangeinfo`` sub-directive.



.. _ai_google_diff:

ai_google
---------
.. versionadded:: 3.21

This differ is currently in BETA and the name and/or directives MAY change in the future, mostly because of the rapid
advances in the technology and the prospect of integrating more generative AI models. Feedback welcomed at
https://github.com/mborsetti/webchanges/discussions.

Prefaces a unified diff with a summary of changes generated by Google's `Gemini Pro 1.5 Generative AI model
<https://ai.google.dev/>`__ (in Preview) called via an API call, which may be free of charge.

Gemini Pro 1.5 is the first widely available model with a context window of up to 1 million tokens, which allows it
to analyze changes in long documents (up to 350,000 words, or about 700 pages single-spaced) such as terms and
conditions, privacy policies, etc. that other models can't handle. For clarity, the model can handle up to 700,000
words, but to do a comparison we need up to a half of this for the old text and the rest for the new text.

.. important:: Requires a system environment variable ``GOOGLE_AI_API_KEY`` containing the Google Cloud AI Studio
   API Key which you obtain `here <https://aistudio.google.com/app/apikey>`__. To access the Gemini Pro 1.5 model
   during the Preview period, make a request `here <https://aistudio.google.com/app/waitlist/97445851>`__. Note that
   starting on 2 May 2024, the use of Gemini API from a project that has billing enabled will be subject to
   `pay-as-you-go pricing <https://ai.google.dev/pricing>`__. To avoid surprises, we recommend you set up your API key
   on a project without billing or, at a minimum, set up a `budget
   <https://console.cloud.google.com/billing/01457C-2ABCC1-8A6144/budgets>`__ with threshold notification.

To improve speed and reduce the number of tokens, we generate a separate, complete, unified diff which we feed to
the Generative AI model to summarize. See below for a custom prompt that instead feeds both the old data and the new
data to the model asking it to do the comparison.

This differ also works with less-powerful Google models, such as Gemini 1.0 Pro (see the ``model`` directive), whose
access is not gated.

.. warning:: Generative AI can "hallucinate" (make things up), so **always** double-check the AI-generated summary with
   the accompanying unified diff.

Examples
````````
The example below used the default prompt, which prefaces a summary to the unified diff.

.. image:: differ_ai_google_example.png
  :width: 1039
  :alt: Google AI differ example output

The job directive below will use a custom prompt to have the Generative AI summarize the differences, which requires a
lot more tokens and time but may work better in certain cases. More information about writing input prompts can be
found `here <https://ai.google.dev/docs/prompt_best_practices>`__.

.. code-block:: yaml

   command: date
   differ:
     name: ai_google
     prompt: Identify and summarize the changes:\n\n<old>\n{old_data}\n</old>\n\n<new>\n{new_data}\n</new>

Mandatory environment variable
``````````````````````````````
* ``GOOGLE_AI_API_KEY``: Must contain your Google Cloud AI Studio `API Key <https://aistudio.google.com/app/apikey>`__.

Optional directives
```````````````````
This differ is currently in BETA and the directives MAY change in the future.

.. model default is retrievable from
   https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-pro-latest?key=$GOOGLE_AI_API_KEY

* ``model``: A `model name <https://ai.google.dev/models/gemini>`__ (default: ``gemini-1.5-pro-latest``).
* ``prompt``: The prompt sent to the model; the strings ``{unified_diff}``, ``{old_data}`` and ``{new_data}`` will
  be replaced by the respective content. (default: ``Summarize this unified diff:\n\n{unified_diff}``).
* ``context_lines`` (int): Context lines used in the ``unified_diff`` fed to the model, if one is used in the
  ``prompt`` (default: 999). Note that this is different than the one in the report itself, which uses the job's
  :ref:`contextlines` directive. If the resulting model prompt becomes approximately too big for the model to
  handle, the unified_diff will be recalculated with the default number of context lines (3).
* ``timeout`` (float): The number of seconds before timing out the API call (default: 300).
* ``temperature`` (float between 0.0 and 1.0): The model's Temperature parameter, which controls randomness; higher
  values increase diversity (default: 0.0).
* ``top_k`` (int 1 or greater): The model's TopK parameter, i.e. sample from the k most likely next tokens at
  each step; lower k focuses on higher probability tokens (default: model-dependent, but typically 1, see Google
  documentation; not available in ``gemini-1.5-pro-latest``)
* ``top_p`` (float between 0.0 and 1.0): The model's TopP parameter, or the cumulative probability cutoff for token
  selection; lower p means sampling from a smaller, more top-weighted nucleus and reduce diversity (default:
  model-dependent, but typically 0.95 or 1.0, see Google documentation)
* ``token_limit`` (int): The maximum size of the model's context window, overriding the model's default (used for
  internal code testing).

.. note:: You can learn about Temperature, TopK and TopP parameters `here
   <https://ai.google.dev/docs/concepts#model-parameters>`__. In general, temperature increases creativity and
   diversity in phrasing variety, while top-p and top-k influences variety of individual words and low values may
   lead to potentially repetitive summaries. The only way to get these "right" is through experimentation on you
   actual data, as the results are highly subjective on it in addition to your personal preferences.

.. tip:: You can do "dry-runs" of this (or any) differ on an existing job by editing the job with the different differ
   and running e.g. ``webchanges --test-differ 1 --test-reporter browser``. Don't forget to revert your job file if you
   don't like the new outcome!



.. _command_diff:

command
-------
Executes an outside command to use an external differ (e.g. wdiff). The external program will have to exit with a
status of 0 if no differences were found, a status of 1 if any differences were found, or a any other status for any
error. The directive ``name`` is not required for increased legibility.

If ``wdiff`` is used, its output will be colorized when displayed on stdout (typically a screen) and for HTML reports.

Example:

.. code-block:: yaml

   url: https://example.net/command.html
   differ:
     command: wdiff

Please see warning :ref:`important_note_for_command_jobs` for the file security settings required to run jobs with
this differ in Linux.

.. versionchanged:: 3.21
   Previously a job sub-directive by the name of ``diff_tool``.

.. _deepdiff_diff:

deepdiff
--------
.. versionadded:: 3.21

Inspects structured data (JSON or XML) element by element and reports which elements have changed, using a customized
report from deepdiff's library `DeepDiff <https://zepworks.com/deepdiff/current/diff.html#module-deepdiff.diff>`__
module.

Examples:

.. code-block:: yaml

   url: https://example.net/deepdiff_json.html
   differ: deepdiff  # defaults to json data


.. code-block:: yaml

   url: https://example.net/deepdiff_xml_ignore_oder.html
   differ:
     name: deepdiff
     data_type: xml
     ignore_order: true

Optional directives
```````````````````
* ``data_type``: The type of data being analyzed, either ``json`` or ``xml`` (default: ``json``).
* ``ignore_order`` (true/false): Whether to ignore the order in which the items have appeared (default: false).
* ``ignore_string_case`` (true/false): Whether to be case-sensitive or not when comparing strings (default: false).
* ``significant_digits`` (int): The number of digits AFTER the decimal point to be used in the comparison (default:
  no limit).

Required packages
`````````````````
To run jobs with this differ, you need to first install :ref:`additional Python packages <optional_packages>` as
follows:

.. code-block:: bash

   pip install --upgrade webchanges[deepdiff]



.. _image_diff:

image
-----
.. versionadded:: 3.21

This differ is currently in BETA, mostly because it's unclear what more needs to be changed or parametrized in order
to make the differ work with a vast variety of images. Feedback welcomed at
https://github.com/mborsetti/webchanges/discussions.

Highlights changes in an image by overlaying them in yellow on a greyscale version of the original image.

.. code-block:: yaml

   url: https://example.net/image.html
   differ:
     name: image
     data_type: url

Optional directives
```````````````````
This differ is currently in BETA and the directives may change in the future.

* ``data_type``: What the data represent: can be ``url``, for a link to the image, ``bytes``, for the image in bytes,
  or ``filename``, for the path to the file containing the image (default: ``url``)

Required packages
`````````````````
To run jobs with this differ, you need to first install :ref:`additional Python packages <optional_packages>` as
follows:

.. code-block:: bash

   pip install --upgrade webchanges[imagediff]

In addition, you can only run it with a default configuration of :program:webchanges:, which installsthe
``httpx`` HTTP Client library; ``requests`` is not supported.



.. _table_diff:

table
-----
Similar to :ref:`unified <unified_diff>`, it performs a line-by-line comparison and reports lines that have been added,
deleted, or changed, but in an HTML table format, using Python's `difflib.HtmlDiff
<https://docs.python.org/3/library/difflib.html#difflib.HtmlDiff>`__. Example output:

.. raw:: html

   <embed>
     <style>
        .diff { border: 2px solid; }
        .diff_add { color: green; background-color: lightgreen; }
        .diff_sub { color: red; background-color: lightred; }
        .diff_chg { color: orange; background-color: lightyellow; }
     </style>
     <!-- Created in Python 3.12 -->
     <table class="diff" id="difflib_chg_to0__top" cellspacing="0" cellpadding="0" rules="groups" >
       <colgroup></colgroup> <colgroup></colgroup> <colgroup></colgroup>
       <colgroup></colgroup> <colgroup></colgroup> <colgroup></colgroup>
       <tbody>
       <tr>
         <td class="diff_next" id="difflib_chg_to0__1"><a href="#difflib_chg_to0__0">f</a></td>
         <td class="diff_header" id="from0_1">1</td>
         <td nowrap="nowrap">This&nbsp;line&nbsp;is&nbsp;the&nbsp;same</td>
         <td class="diff_next"><a href="#difflib_chg_to0__0">f</a></td>
         <td class="diff_header" id="to0_1">1</td>
         <td nowrap="nowrap">This&nbsp;line&nbsp;is&nbsp;the&nbsp;same</td>
       </tr>
       <tr>
         <td class="diff_next"><a href="#difflib_chg_to0__1">n</a></td>
         <td class="diff_header" id="from0_2">2</td>
         <td nowrap="nowrap"><span class="diff_sub">This&nbsp;line&nbsp;is&nbsp;in&nbsp;the&nbsp;left&nbsp;file&nbsp;but&nbsp;not&nbsp;the&nbsp;right</span></td>
         <td class="diff_next"><a href="#difflib_chg_to0__1">n</a></td>
         <td class="diff_header"></td>
         <td nowrap="nowrap"></td>
       </tr>
       <tr>
         <td class="diff_next"></td>
         <td class="diff_header" id="from0_3">3</td>
         <td nowrap="nowrap">Another&nbsp;line&nbsp;that&nbsp;is&nbsp;the&nbsp;same</td>
         <td class="diff_next"></td>
         <td class="diff_header" id="to0_2">2</td>
         <td nowrap="nowrap">Another&nbsp;line&nbsp;that&nbsp;is&nbsp;the&nbsp;same</td>
       </tr>
       <tr>
         <td class="diff_next"><a href="#difflib_chg_to0__top">t</a></td>
         <td class="diff_header"></td>
         <td nowrap="nowrap"></td>
         <td class="diff_next"><a href="#difflib_chg_to0__top">t</a></td>
         <td class="diff_header" id="to0_3">3</td>
         <td nowrap="nowrap"><span class="diff_add">This&nbsp;line&nbsp;is&nbsp;in&nbsp;the&nbsp;right&nbsp;file&nbsp;but&nbsp;not&nbsp;the&nbsp;left</span></td>
       </tr>
       </tbody>
    </table>
   </embed>

|

For backwards compatibility, this is the default differ for an ``html`` reporter with the deprecated configuration
setting ``diff`` set to ``html``.


.. code-block:: yaml

   url: https://example.net/table.html
   differ: table

Optional directives
```````````````````
* ``tabsize``: tab stop spacing (default: 8).

.. versionchanged:: 3.21
   Became a standalone differ (previously only accessible through configuration file settings).
   Added the ``tabsize`` directive.
